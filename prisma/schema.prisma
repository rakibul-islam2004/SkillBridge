// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================
enum Role {
  STUDENT
  TUTOR
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum CalendarBlockType {
  TEACHING
  LEARNING
  BUFFER
  MANUAL
}

// ==================== USERS ====================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   @map("passwordHash")
  role      Role     @default(STUDENT)
  fullname  String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentProfile StudentProfile?
  tutorProfile   TutorProfile?
  adminProfile   Admin?
  calendarBlocks CalendarBlock[]

  @@map("user")
}

// ==================== STUDENT PROFILE ====================
model StudentProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  bio       String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User @relation(fields: [userId], references: [id])
  bookings  Booking[]
  reviews   Review[]

  @@map("student_profile")
}

// ==================== TUTOR PROFILE ====================
model TutorProfile {
  id               String   @id @default(uuid())
  userId           String   @unique
  bio              String?
  experience       Int?
  experienceDetails String?
  ratingAvg        Float    @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user           User              @relation(fields: [userId], references: [id])
  availabilities TutorAvailability[]
  pricings       TutorPricing[]
  tutorCategories TutorCategory[]
  bookings       Booking[]
  reviews        Review[]

  @@map("tutor_profile")
}

// ==================== ADMIN ====================
model Admin {
  id        String   @id @default(uuid())
  userId    String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User @relation(fields: [userId], references: [id])

  @@map("admin")
}

// ==================== CATEGORY ====================
model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  tutorCategories TutorCategory[]

  @@map("category")
}

// ==================== TUTOR CATEGORY ====================
model TutorCategory {
  id         String   @id @default(uuid())
  tutorId    String
  categoryId String

  tutor      TutorProfile @relation(fields: [tutorId], references: [id])
  category   Category     @relation(fields: [categoryId], references: [id])

  @@map("tutor_category")
}

// ==================== TUTOR PRICING ====================
model TutorPricing {
  id         String   @id @default(uuid())
  tutorId    String
  durationMinutes Int
  price      Decimal
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tutor      TutorProfile @relation(fields: [tutorId], references: [id])
  bookings   Booking[]

  @@map("tutor_pricing")
}

// ==================== TUTOR AVAILABILITY ====================
model TutorAvailability {
  id         String   @id @default(uuid())
  tutorId    String
  startTime  DateTime
  endTime    DateTime
  isRecurring Boolean @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tutor          TutorProfile @relation(fields: [tutorId], references: [id])
  calendarBlocks CalendarBlock[]
  bookings       Booking[]

  @@map("tutor_availability")
}

// ==================== BOOKING ====================
model Booking {
  id            String   @id @default(uuid())
  studentId     String
  tutorId       String
  pricingId     String
  availabilityId String
  startTime     DateTime
  endTime       DateTime
  status        BookingStatus @default(PENDING)
  meetingLink   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  student      StudentProfile  @relation(fields: [studentId], references: [id])
  tutor        TutorProfile    @relation(fields: [tutorId], references: [id])
  pricing      TutorPricing    @relation(fields: [pricingId], references: [id])
  availability TutorAvailability @relation(fields: [availabilityId], references: [id])
  review       Review?

  calendarBlocks CalendarBlock[]

  @@map("booking")
}

// ==================== REVIEW ====================
model Review {
  id        String   @id @default(uuid())
  bookingId String   @unique
  studentId String
  tutorId   String
  rating    Int
  comment   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking  Booking @relation(fields: [bookingId], references: [id])
  student  StudentProfile @relation(fields: [studentId], references: [id])
  tutor    TutorProfile   @relation(fields: [tutorId], references: [id])

  @@map("review")
}

// ==================== CALENDAR BLOCK ====================
model CalendarBlock {
  id             String   @id @default(uuid())
  availabilityId String
  bookingId      String?
  userId         String
  startTime      DateTime
  endTime        DateTime
  type           CalendarBlockType
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  availability   TutorAvailability @relation(fields: [availabilityId], references: [id])
  booking        Booking? @relation(fields: [bookingId], references: [id])
  user           User @relation(fields: [userId], references: [id])

  @@map("calendar_block")
}
